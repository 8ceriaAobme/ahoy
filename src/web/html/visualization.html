<!doctype html>
<html>
    <head>
        <title>Live</title>
        {#HTML_HEADER}
        <meta name="apple-mobile-web-app-capable" content="yes">
    </head>
    <body>
        {#HTML_NAV}
        <div id="wrapper">
            <div id="content">
                <div id="live"></div>
                <p>Every <span id="refresh"></span> seconds the values are updated</p>
            </div>
        </div>
        {#HTML_FOOTER}
        <script type="text/javascript">
            var exeOnce = true;

            function parseGeneric(obj) {
                if(true == exeOnce){
                    parseNav(obj);
                    parseESP(obj);
                }
                parseRssi(obj);
            }

            function parseIv(obj, root) {
                var ivHtml = [];

                var tDiv = div(["ch-all", "iv"]);
                tDiv.appendChild(span("Total", ["head"]));
                var total = new Array(root.ch0_fld_names.length).fill(0);
                if(obj.length > 1)
                    ivHtml.push(tDiv);

                for(var iv of obj) {
                    if(iv["enabled"]) {
                        main = div(["iv"]);
                        var ch0 = div(["ch-iv"]);
                        var limit = iv["power_limit_read"] + "%";
                        if(limit == "65535%")
                            limit = "n/a";
                        ch0.appendChild(span(iv["name"] + " Limit " + limit, ["head"]));

                        for(var j = 0; j < root.ch0_fld_names.length; j++) {
                            var val = Math.round(iv["ch"][0][j] * 100) / 100;
                            var sub = div(["subgrp"]);
                            sub.appendChild(span(val + " " + span(root["ch0_fld_units"][j], ["unit"]).innerHTML, ["value"]));
                            sub.appendChild(span(root["ch0_fld_names"][j], ["info"]));
                            ch0.appendChild(sub);

                            switch(j) {
                                case 2:  total[j] += val; break; // P_AC
                                case 6:  total[j] += val; break; // YieldTotal
                                case 7:  total[j] += val; break; // YieldDay
                                case 8:  total[j] += val; break; // P_DC
                                case 10: total[j] += val; break; // Q_AC
                            }
                        }
                        main.appendChild(ch0);


                        for(var i = 1; i < (iv["channels"] + 1); i++) {
                            var ch = div(["ch"]);
                            ch.appendChild(span(("" == iv["ch_names"][i]) ? ("CHANNEL " + i) : iv["ch_names"][i], ["head"]));

                            for(var j = 0; j < root.fld_names.length; j++) {
                                var val = Math.round(iv["ch"][i][j] * 100) / 100;
                                ch.appendChild(span(val + " " + span(root["fld_units"][j], ["unit"]).innerHTML, ["value"]));
                                ch.appendChild(span(root["fld_names"][j], ["info"]));
                            }
                            main.appendChild(ch);
                        }

                        var ts = div(["ts"]);
                        var ageInfo = "Last received data requested at: ";
                        if(iv["ts_last_success"] > 0) {
                            var date = new Date(iv["ts_last_success"] * 1000);
                            ageInfo += date.toLocaleString('de-DE');
                        }
                        else
                            ageInfo += "nothing received";

                        ts.innerHTML = ageInfo;

                        main.appendChild(ts);
                        ivHtml.push(main);
                    }
                }

                // total
                if(obj.length > 1) {
                    for(var j = 0; j < root.ch0_fld_names.length; j++) {
                        var val = Math.round(total[j] * 100) / 100;
                        if((j == 2) || (j == 6) || (j == 7) || (j == 8) || (j == 10)) {
                            var sub = div(["subgrp"]);
                            sub.appendChild(span(val + " " + span(root["ch0_fld_units"][j], ["unit"]).innerHTML, ["value"]));
                            sub.appendChild(span(root["ch0_fld_names"][j], ["info"]));
                            tDiv.appendChild(sub);
                        }
                    }
                }

                document.getElementById("live").replaceChildren(...ivHtml);
            }

            function parse(obj) {
                if(null != obj) {
                    parseGeneric(obj["generic"]);
                    parseIv(obj["inverter"], obj);
                    document.getElementById("refresh").innerHTML = obj["refresh_interval"];
                    if(true == exeOnce) {
                        window.setInterval("getAjax('/api/live', parse)", obj["refresh_interval"] * 1000);
                        exeOnce = false;
                    }
                }
                else
                    document.getElementById("refresh").innerHTML = "n/a";
            }

            getAjax("/api/live", parse);
        </script>
    </body>
</html>
